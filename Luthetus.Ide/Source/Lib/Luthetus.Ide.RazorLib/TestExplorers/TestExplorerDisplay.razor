@using Luthetus.Common.RazorLib.Contexts.Displays
@using Luthetus.Common.RazorLib.Contexts.Models
@using Luthetus.Ide.RazorLib.Terminals.Displays
@using Luthetus.Ide.RazorLib.Terminals.Models
@using System.Collections.Immutable
@using Luthetus.Common.RazorLib.Dropdowns.Displays
@using Luthetus.Common.RazorLib.Dropdowns.Models;
@using Luthetus.Common.RazorLib.TreeViews.Displays
@using Luthetus.Common.RazorLib.TreeViews.Models;

@inherits Fluxor.Blazor.Web.Components.FluxorComponent

<ContextBoundary ContextRecord="ContextFacts.TestExplorerContext"
                 ClassCssString="luth_ide_test-explorer"
                 StyleCssString="height: 100%; width: 100%;">

    <div class="luth_ide_section-title">
        Test Explorer
    </div>

    <div class="luth_ide_section-body"
         style="width: 100%;">
  
		<div>
			@{
				var generalTerminalSession = TerminalSessionsStateWrap.Value.TerminalSessionMap[
                	TerminalSessionFacts.GENERAL_TERMINAL_SESSION_KEY];
			}
			WorkingDirectoryAbsolutePathString:&nbsp;
			@(generalTerminalSession.WorkingDirectoryAbsolutePathString ?? "null")
		</div>

		<hr/>

		<div class="luth_ide_form-group">
	        <div class="luth_ide_form-label">
	            Directory:
	        </div>
	
	        <div class="luth_ide_form-value"
	             style="display: flex;">
	
	            <input class="luth_ide_input luth_ide_input-text"
	                   style="height: 2em;"
	                   placeholder="Directory for test discovery"
	                   @bind="_directoryNameForTestDiscovery"
	                   @bind:event="oninput"/>
	
	            <button class="luth_button"
	                    @onclick="RequestInputFileForTestDiscovery">
	                <IconFolder/>
	            </button>
	        </div>
    	</div>

		<hr/>      
        
		<button class="luth_button"
				@onclick="StartDotNetTestListTestsCommandOnClick">
			DOTNET_TEST_LIST_TESTS_COMMAND
		</button>

		<button class="luth_button"
				style="margin-top: 15px;"
				@onclick="SetTreeViewAsync">
			SetTreeViewAsync @(RootStringFragmentMap.Count) @(_firstIf)
		</button>

		<hr/>

		@{
			var localRootStringFragmentMap = RootStringFragmentMap;
			
			if (localRootStringFragmentMap.Count == 0)
			{
				<div>NO OUTPUT</div>
			}
			else
			{
				<CascadingValue Name="LuthetusTreeViewIconWidth" Value="AppOptionsStateWrap.Value.Options.IconSizeInPixels">
	                <CascadingValue Name="LuthetusTreeViewIconHeight" Value="AppOptionsStateWrap.Value.Options.IconSizeInPixels">
	                    <CascadingValue Name="OffsetPerDepthInPixels" Value="OffsetPerDepthInPixels">
	                        <TreeViewContainerDisplay TreeViewStateKey="TreeViewTestExplorerKey"
	                                                  CssStyleString="height: 100%;"
	                                                  OnContextMenuFunc="OnTreeViewContextMenuFunc"
	                                                  TreeViewKeyboardEventHandler="_treeViewKeyboardEventHandler"
	                                                  TreeViewMouseEventHandler="_treeViewMouseEventHandler" />
	                    </CascadingValue>
	                </CascadingValue>
	            </CascadingValue>

				<DropdownDisplay DropdownKey="TestExplorerContextMenu.ContextMenuEventDropdownKey"
	                             DropdownPositionKind="DropdownPositionKind.Unset"
	                             CssStyleString="@TestExplorerContextMenu.GetContextMenuCssStyleString(_mostRecentTreeViewCommandArgs)">
	
	                <TestExplorerContextMenu TreeViewCommandArgs="_mostRecentTreeViewCommandArgs" />
	            </DropdownDisplay>
			}
		}

		<hr/>
		
		<div style="height: 150px;">
			<div>DotNetTestListTestsTerminalCommandKey Terminal Output:</div>
			<TerminalOutputDisplay TerminalSessionKey="TerminalSessionFacts.GENERAL_TERMINAL_SESSION_KEY" 
                                   TerminalCommandKey="DotNetTestListTestsTerminalCommandKey" />
		</div>
		
		<div style="height: 150px;">
			<div>DotNetTestByFullyQualifiedNameFormattedTerminalCommandKey Terminal Output:</div>
			<TerminalOutputDisplay TerminalSessionKey="TerminalSessionFacts.GENERAL_TERMINAL_SESSION_KEY" 
                                   TerminalCommandKey="DotNetTestByFullyQualifiedNameFormattedTerminalCommandKey" />
		</div>
    </div>
</ContextBoundary>